name: Run PHPCS on pull requests

on:
- push
- pull_request

jobs:
  build:
    name: Build
    strategy:
      matrix:
        node: ['14.15.1']
        php: ['7.4']
    runs-on: ubuntu-latest
    container:
      image: php:${{ matrix.php }}
      volumes:
      - $GITHUB_WORKSPACE:/var/www/html
    steps:
    - name: Set up container
      run: |
        echo "Install base packages"
        apt-get update
        apt-get install -y build-essential \
        libssl-dev \
        gnupg \
        libfreetype6-dev \
        libicu-dev \
        libjpeg62-turbo-dev \
        libmcrypt-dev \
        libonig-dev \
        libxml2-dev \
        vim \
        wget \
        unzip \
        git \
        subversion \
        default-mysql-client

        echo "Install composer"
        curl -sS -L https://getcomposer.org/installer | php
        mv composer.phar /usr/local/bin/composer

        echo "Install PHP extensions"
        docker-php-ext-install -j$(nproc) iconv intl xml soap opcache pdo pdo_mysql mysqli mbstring gd

    - name: Install phive
      run: |
        wget -O phive.phar "https://phar.io/releases/phive.phar"
        wget -O phive.phar.asc "https://phar.io/releases/phive.phar.asc"
        gpg --keyserver hkps.pool.sks-keyservers.net --recv-keys 0x9D8A98B29B2D5D79
        gpg --verify phive.phar.asc phive.phar
        rm phive.phar.asc
        chmod +x phive.phar
        mv phive.phar /usr/local/bin/phive

    - uses: actions/checkout@v1

    - name: Install phpcs
      run: |
        phive install phpcs --trust-gpg-keys 31C7E470E2138192
        git clone -b master --depth 1 https://github.com/WordPress/WordPress-Coding-Standards.git /tmp/sniffs
        ./tools/phpcs --config-set installed_paths /tmp/sniffs

    - name: Run PHPCS Coding Standards
      run: ./tools/phpcs $GITHUB_WORKSPACE
